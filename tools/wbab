#!/usr/bin/env bash
set -euo pipefail

# CLI scaffold. This is intentionally thin and scriptable while the
# daemon/core is brought up in later increments.

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SMOKE_RUNNER="${ROOT_DIR}/tools/winebot-smoke.sh"
BUILD_RUNNER="${ROOT_DIR}/tools/winbuild-build.sh"
PACKAGE_RUNNER="${ROOT_DIR}/tools/package-nsis.sh"
SIGN_RUNNER="${ROOT_DIR}/tools/sign-dev.sh"
EXIT_NOT_IMPLEMENTED=10

usage() {
  cat <<'EOF'
WineBotAppBuilder (wbab)

Usage:
  wbab <verb> [args...]

Required verbs:
  build
  package
  sign
  smoke
  doctor
  plan

Notes:
- `doctor`, `build`, `package`, `sign`, `smoke`, and `plan` are implemented in the bring-up scaffold.
EOF
}

die() {
  echo "wbab: $*" >&2
  exit 2
}

require_arg() {
  local value="${1:-}"
  local what="${2:-argument}"
  if [[ -z "${value}" ]]; then
    die "missing ${what}"
  fi
}

cmd_doctor() {
  local ok=1

  if command -v docker >/dev/null 2>&1; then
    if docker compose version >/dev/null 2>&1; then
      echo "doctor: docker compose v2 available"
    elif command -v docker-compose >/dev/null 2>&1; then
      echo "doctor: docker-compose v1 available"
    else
      echo "doctor: missing compose (docker compose or docker-compose)" >&2
      ok=0
    fi
  else
    echo "doctor: missing docker" >&2
    ok=0
  fi

  if [[ -f "${ROOT_DIR}/tools/WineBot/compose/docker-compose.yml" ]]; then
    echo "doctor: WineBot compose file found"
  else
    echo "doctor: WineBot compose file missing at tools/WineBot/compose/docker-compose.yml" >&2
    echo "doctor: hint: run ./scripts/bootstrap-submodule.sh" >&2
    ok=0
  fi

  if [[ "${ok}" -eq 1 ]]; then
    echo "doctor: OK"
    return 0
  fi

  echo "doctor: FAILED"
  return 1
}

json_escape() {
  local s="${1:-}"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  s="${s//$'\n'/\\n}"
  printf '%s' "${s}"
}

cmd_plan() {
  local target="${1:-}"
  require_arg "${target}" "target verb for plan"
  shift || true

  local allow_local_build="${WBAB_ALLOW_LOCAL_BUILD:-0}"
  local toolchain_image="${WBAB_TOOLCHAIN_IMAGE:-ghcr.io/sempersupra/winebotappbuilder-winbuild}"
  local toolchain_tag="${WBAB_TAG:-stable}"
  local packager_image="${WBAB_PACKAGER_IMAGE:-ghcr.io/sempersupra/winebotappbuilder-packager}"
  local packager_tag="${WBAB_TAG:-stable}"
  local signer_image="${WBAB_SIGNER_IMAGE:-ghcr.io/sempersupra/winebotappbuilder-signer}"
  local signer_tag="${WBAB_TAG:-stable}"
  local sign_use_dev_cert="${WBAB_SIGN_USE_DEV_CERT:-0}"
  local dev_cert_dir="${WBAB_DEV_CERT_DIR:-.wbab/signing/dev}"
  local winebot_image="${WBAB_WINEBOT_IMAGE:-ghcr.io/mark-e-deyoung/winebot}"
  local winebot_tag="${WBAB_WINEBOT_TAG:-stable}"
  local winebot_profile="${WBAB_WINEBOT_PROFILE:-headless}"
  local winebot_service="${WBAB_WINEBOT_SERVICE:-winebot}"
  local wbab_tag="${WBAB_TAG:-}"

  case "${target}" in
    smoke)
      local installer="${1:-}"
      require_arg "${installer}" "installer path for smoke plan"
      cat <<EOF
{
  "version": "0.1",
  "command": "smoke",
  "inputs": {
    "installer": "$(json_escape "${installer}")"
  },
  "policy": {
    "wbab_tag": "$(json_escape "${wbab_tag}")",
    "allow_local_build": "${allow_local_build}",
    "winebot_image": "$(json_escape "${winebot_image}")",
    "winebot_tag": "$(json_escape "${winebot_tag}")",
    "winebot_profile": "$(json_escape "${winebot_profile}")",
    "winebot_service": "$(json_escape "${winebot_service}")"
  },
  "steps": [
    "validate_installer_exists",
    "pull_winebot_image",
    "start_winebot_no_build_by_default",
    "install_installer_in_winebot",
    "capture_artifacts"
  ]
}
EOF
      ;;
    build)
      local project_dir="${1:-.}"
      cat <<EOF
{
  "version": "0.1",
  "command": "build",
  "inputs": {
    "project_dir": "$(json_escape "${project_dir}")"
  },
  "policy": {
    "allow_local_build": "${allow_local_build}",
    "toolchain_image": "$(json_escape "${toolchain_image}")",
    "toolchain_tag": "$(json_escape "${toolchain_tag}")"
  },
  "steps": [
    "pull_toolchain_image_by_default",
    "run_containerized_build_command",
    "write_outputs_to_out"
  ]
}
EOF
      ;;
    package)
      local project_dir="${1:-.}"
      cat <<EOF
{
  "version": "0.1",
  "command": "package",
  "inputs": {
    "project_dir": "$(json_escape "${project_dir}")"
  },
  "policy": {
    "allow_local_build": "${allow_local_build}",
    "packager_image": "$(json_escape "${packager_image}")",
    "packager_tag": "$(json_escape "${packager_tag}")"
  },
  "steps": [
    "pull_packager_image_by_default",
    "run_containerized_packaging_command",
    "write_outputs_to_dist"
  ]
}
EOF
      ;;
    sign)
      local project_dir="${1:-.}"
      cat <<EOF
{
  "version": "0.1",
  "command": "sign",
  "inputs": {
    "project_dir": "$(json_escape "${project_dir}")"
  },
  "policy": {
    "allow_local_build": "${allow_local_build}",
    "signer_image": "$(json_escape "${signer_image}")",
    "signer_tag": "$(json_escape "${signer_tag}")",
    "sign_use_dev_cert": "${sign_use_dev_cert}",
    "dev_cert_dir": "$(json_escape "${dev_cert_dir}")"
  },
  "steps": [
    "pull_signer_image_by_default",
    "run_containerized_signing_command",
    "write_signed_outputs_to_dist"
  ]
}
EOF
      ;;
    doctor)
      cat <<EOF
{
  "version": "0.1",
  "command": "doctor",
  "steps": [
    "check_docker",
    "check_compose",
    "check_winebot_submodule"
  ]
}
EOF
      ;;
    *)
      die "unknown target for plan: ${target}"
      ;;
  esac
}

cmd_smoke() {
  if [[ ! -x "${SMOKE_RUNNER}" ]]; then
    die "smoke runner not found or not executable: ${SMOKE_RUNNER}"
  fi
  "${SMOKE_RUNNER}" "$@"
}

cmd_build() {
  if [[ ! -x "${BUILD_RUNNER}" ]]; then
    die "build runner not found or not executable: ${BUILD_RUNNER}"
  fi
  "${BUILD_RUNNER}" "$@"
}

cmd_package() {
  if [[ ! -x "${PACKAGE_RUNNER}" ]]; then
    die "package runner not found or not executable: ${PACKAGE_RUNNER}"
  fi
  "${PACKAGE_RUNNER}" "$@"
}

cmd_sign() {
  if [[ ! -x "${SIGN_RUNNER}" ]]; then
    die "sign runner not found or not executable: ${SIGN_RUNNER}"
  fi
  "${SIGN_RUNNER}" "$@"
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "" ]]; then
  usage
  exit 0
fi

verb="$1"; shift || true

case "${verb}" in
  doctor)
    cmd_doctor "$@"
    ;;
  smoke)
    cmd_smoke "$@"
    ;;
  build)
    cmd_build "$@"
    ;;
  package)
    cmd_package "$@"
    ;;
  sign)
    cmd_sign "$@"
    ;;
  plan)
    cmd_plan "$@"
    ;;
  *)
    die "unknown verb: ${verb}"
    ;;
esac
