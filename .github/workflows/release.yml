name: Release Automation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Run all tests (containerized)
        run: |
          export WBAB_ALLOW_LOCAL_BUILD=1
          
          # Fix permissions for non-root containers (UID 1000)
          sudo chown -R 1000:1000 .
          
          chmod +x scripts/lint.sh scripts/lint-container.sh tests/shell/run.sh tests/contract/run.sh tests/policy/run.sh tests/e2e/run.sh
          ./scripts/lint.sh
          ./tests/shell/run.sh
          ./tests/contract/run.sh
          ./tests/policy/run.sh
          ./tests/e2e/run.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Dry-check publish Dockerfiles (local/CI parity)
        run: |
          set -euo pipefail
          scripts/publish/dockerfiles-drycheck.sh

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish images
        env:
          OWNER: ${{ github.repository_owner }}
          TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          owner_lc="$(echo "${OWNER}" | tr '[:upper:]' '[:lower:]')"
          mkdir -p artifacts
          : > artifacts/publish-digests.txt

          publish_if_exists() {
            local dockerfile="$1"
            local image_name="$2"
            if [[ ! -f "${dockerfile}" ]]; then
              echo "SKIP: missing ${dockerfile}"
              return 0
            fi

            local image="ghcr.io/${owner_lc}/${image_name}"
            local metadata_file="artifacts/${image_name}.metadata.json"
            echo "Publishing ${image}:${TAG}"
            docker buildx build \
              --file "${dockerfile}" \
              --tag "${image}:${TAG}" \
              --tag "${image}:latest" \
              --label "org.opencontainers.image.source=https://github.com/${REPO}" \
              --label "org.opencontainers.image.revision=${SHA}" \
              --label "org.opencontainers.image.version=${TAG}" \
              --label "org.opencontainers.image.title=${image_name}" \
              --provenance=true \
              --sbom=true \
              --metadata-file "${metadata_file}" \
              --push \
              .

            digest="$(jq -r '.["containerimage.digest"] // empty' "${metadata_file}")"
            if [[ -z "${digest}" ]]; then
              echo "ERROR: missing container digest in ${metadata_file}" >&2
              exit 1
            fi
            echo "${image}:${TAG}@${digest}" >> artifacts/publish-digests.txt
          }

          publish_if_exists "tools/winbuild/Dockerfile" "winebotappbuilder-winbuild"
          publish_if_exists "tools/packaging/Dockerfile" "winebotappbuilder-packager"
          publish_if_exists "tools/signing/Dockerfile" "winebotappbuilder-signer"
          publish_if_exists "tools/linter/Dockerfile" "winebotappbuilder-linter"

      - name: Build sample installer for release asset
        run: |
          export WBAB_ALLOW_LOCAL_BUILD=1
          export WBAB_BUILD_CMD="wbab-build-real"
          export WBAB_PACKAGE_CMD="wbab-package-real"
          
          # Fix permissions for non-root containers (UID 1000)
          sudo chown -R 1000:1000 .
          
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          docker build -t "ghcr.io/${OWNER_LC}/winebotappbuilder-winbuild:local" -f tools/winbuild/Dockerfile .
          docker build -t "ghcr.io/${OWNER_LC}/winebotappbuilder-packager:local" -f tools/packaging/Dockerfile .
          
          # Force wbab to use the local images we just built
          export WBAB_TOOLCHAIN_IMAGE="ghcr.io/${OWNER_LC}/winebotappbuilder-winbuild"
          export WBAB_PACKAGER_IMAGE="ghcr.io/${OWNER_LC}/winebotappbuilder-packager"
          export WBAB_TAG="local"
          
          ./tools/wbab build samples/validation-app
          ./tools/wbab package samples/validation-app

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "Release ${{ github.ref_name }}" \
            --generate-notes \
            samples/validation-app/dist/ValidationSetup.exe

      - name: Upload publish metadata
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-metadata
          path: artifacts/**
          if-no-files-found: warn
