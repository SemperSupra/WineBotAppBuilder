name: CI

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - 'docs/**'
      - 'manual/**'
      - '**.md'
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'manual/**'
      - '**.md'

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Run containerized lint
        run: |
          export WBAB_ALLOW_LOCAL_BUILD=0
          chmod +x scripts/lint.sh scripts/lint-container.sh
          ./scripts/lint.sh

  shell-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - name: Run shell unit tests (mocked)
        run: |
          chmod +x tests/shell/run.sh
          ./tests/shell/run.sh

  contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - name: Run contract tests
        run: |
          chmod +x tests/contract/run.sh
          ./tests/contract/run.sh

  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - name: Run policy tests
        run: |
          chmod +x tests/policy/run.sh
          ./tests/policy/run.sh

  e2e-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - name: Run mocked e2e smoke pipeline
        run: |
          chmod +x tests/e2e/run.sh
          ./tests/e2e/run.sh
